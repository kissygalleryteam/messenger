/*! messenger - v1.0 - 2013-09-26 9:39:05 AM
* Copyright (c) 2013 nanqiu; Licensed  */
KISSY.add("gallery/messenger/1.0/index",function(a,b,c,d,e,f){function g(a,b){s.push([a,b])}function h(c,d,f){var g={type:c,content:d},h=f;a.isString(f)?(h=b.get("#"+f),f=h.contentWindow):q||r||f.contentWindow&&(f=f.contentWindow),q?setTimeout(function(){l.callSWF?l.callSWF("send",[g,k(h)]):l.send(g,k(h))},500):f.postMessage(e.stringify(g),"*")}function i(b,c){a.each(s,function(a){a[0]===b&&a[1](c)})}function j(c,d){var e,f=q?"parentFlash="+t+"&childFlash=_MessengerChildFlash_"+a.now():"";a.isString(c)?(e=c,c={}):e=c.src,c.src=e+(e.indexOf("?")>-1?"&":"?")+f;var g=b.create("<iframe>",c);return g.setAttribute("width",1),g.setAttribute("height",1),b.get(d||"body").appendChild(g)}function k(a){var b=a.src;if(b){var c=b.match(/childFlash=([^&]+)/);if(c&&c[1])return c[1];throw"iframe has no flashName param"}var d=/parentFlash=([^&]+)/,c=p.match(d);if(c&&c[1])return c[1];throw"iframe has no topFlashName param"}var l,m=window,n="1.0",o=n?"http://a.tbcdn.cn/kissy/gallery/messenger/1.0/flash-post-message.swf":"flash-post-message.swf",p=location.search,q="undefined"==typeof postMessage||!m.addEventListener,r=m.top!=m,s=[],t="_MessengerFlash_"+a.now();if(q){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;"message"==c&&d&&i(d.type,d.content)};var u=p.match(/childFlash=([^&]+)/);u&&u[1]&&(t=u[1]);var v={src:o,attrs:{width:1,height:1,style:"position:absolute;top:0"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:t},allowscriptaccess:"always"}};l=new f(v)}else m.addEventListener("message",function(b){var c=b.data;if(c&&a.isString(c))try{var d=e.parse(c);i(d.type,d.content)}catch(f){}},!1);return{register:g,send:h,createIframe:j,flashName:t}},{requires:["dom","event","ua","json","swf"]});